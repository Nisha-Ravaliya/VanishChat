<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VanishChat - Dashboard</title>
    <style>
        * { box-sizing:border-box; margin:0; padding:0; font-family:Arial, sans-serif;}
        body { background:#f0f2f5; color:#333; }
        .topbar { background:#1a1a1a; color:white; height:60px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; position:fixed; top:0; left:0; width:100%; z-index:1000; }
        .topbar img { width:40px; height:40px; border-radius:50%; }
        .topbar .user-info { display:flex; gap:10px; align-items:center; }
        .sidebar { position:fixed; top:60px; left:0; width:230px; height:calc(100%-60px); background:#262D7A; color:white; padding:20px; transition: transform 0.3s; }
        .sidebar h2 { margin-bottom:20px; }
        .sidebar a { display:block; color:white; padding:10px; margin-bottom:10px; border-radius:6px; text-decoration:none; transition:background 0.3s; }
        .sidebar a.active, .sidebar a:hover { background:#00ffaa; color:#262D7A; }
        .sidebar button { margin-top:40px; padding:10px; width:100%; background:#e74c3c; border:none; border-radius:6px; cursor:pointer; }
        main { margin-left:230px; margin-top:60px; padding:20px; transition: margin-left 0.3s; }

        #chatBox { background:#e5ddd5; height:400px; overflow-y:auto; padding:15px; border-radius:10px; }
        .msg { max-width:65%; padding:10px 14px; border-radius:20px; margin:5px 0; font-size:14px; position:relative; }
        .me { background:#dcf8c6; margin-left:auto; border-bottom-right-radius:0; }
        .other { background:white; margin-right:auto; border-bottom-left-radius:0; }
        .time { font-size:10px; opacity:.6; margin-top:4px; text-align:right; }

        table { width:100%; border-collapse:collapse; margin-bottom:20px; }
        th, td { padding:10px; border-bottom:1px solid #ccc; text-align:left; }
        th { background:#00ffaa; color:#262D7A; }
        tr:hover { background:#ecf0f1; cursor:pointer; }
        #msgInput, #chatEmail, #vanishTime { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px; }
        #sendBtn { padding:10px 15px; border:none; background:#00ffaa; color:white; border-radius:6px; cursor:pointer; }

        .profile-form input, .profile-form select, textarea { width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc; }
        .profile-form img { width:80px; height:80px; border-radius:50%; margin-bottom:10px; }

        @media (max-width:992px){
            .sidebar{transform:translateX(-100%);}
            .sidebar.active{transform:translateX(0);}
            main{margin-left:0;}
            .menu-toggle{display:block;font-size:1.5rem;cursor:pointer;}
        }
    </style>
</head>
<body>

<header class="topbar">
    <div class="menu-toggle" onclick="toggleSidebar()">☰</div>
    <div class="user-info">
        <img src="https://via.placeholder.com/40" id="topPic">
        <span id="topName">User</span>
    </div>
</header>

<aside class="sidebar">
    <h2>VanishChat</h2>
    <a href="#" class="active" onclick="showPage('dashboard',event)">Dashboard</a>
    <a href="#" onclick="showPage('chat',event)">Chat</a>
    <a href="#" onclick="showPage('profile',event)">Profile</a>
    <button onclick="logout()">Logout</button>
</aside>

<main>
    <section id="dashboard">
        <h1>Dashboard</h1>
        <table>
            <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Company</th>
                <th>GST Number</th>
                <th>Address</th>
                <th>Pending Chat</th>
            </tr>
            </thead>
            <tbody id="userList"></tbody>
        </table>
    </section>

    <section id="chat" style="display:none;">
        <h1>Chat</h1>
        <input type="email" id="chatEmail" placeholder="Enter recipient email">
        <div id="chatBox"></div>
        <input type="text" id="msgInput" placeholder="Type your message here..." />
        <select id="vanishTime">
            <option value="10">10s</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
        </select>
        <button id="sendBtn">Send</button>
    </section>

    <section id="profile" style="display:none;">
        <h1>Edit Profile</h1>
        <form class="profile-form" id="profileForm">
            <img id="profilePicPreview" src="https://via.placeholder.com/80">
            <input type="file" id="profilePic" accept="image/*">
            <input type="text" id="proUsername" placeholder="Username">
            <input type="email" id="proEmail" placeholder="Email" readonly>
            <input type="password" id="proPassword" placeholder="Password">
            <input type="text" id="proPhone" placeholder="Phone Number">
            <input type="text" id="proBusinessName" placeholder="Company">
            <input type="text" id="proGstNumber" placeholder="GST Number">
            <textarea id="proAddress" placeholder="Address"></textarea>
            <button type="button" onclick="saveProfile()">Save</button>
        </form>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const API = "http://localhost:8080";
    let loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
    if(!loggedUser){ alert("Login required"); window.location.href="/login"; }

    // Fetch latest user data
    async function fetchLoggedUser() {
        const res = await fetch(`${API}/api/profile/${loggedUser.email}`);
        const data = await res.json();
        if(data) loggedUser = data;
        localStorage.setItem("loggedUser", JSON.stringify(loggedUser));
    }

    // WebSocket connection
    let socket = new SockJS(API + "/ws");
    let stomp = Stomp.over(socket);
    stomp.connect({}, () => {
        console.log("WebSocket Connected ✔");
        stomp.subscribe("/topic/chat/" + loggedUser.email, msg => {
            const data = JSON.parse(msg.body);
            if(data.sender !== loggedUser.email){
                alert("New message from: " + data.sender);
            }
            loadChat(data.sender);
        });
    });

    // Dashboard
    async function loadDashboard(){
        await fetchLoggedUser();

        document.getElementById("topName").textContent = loggedUser.username;
        document.getElementById("topPic").src = loggedUser.profilePic || "https://via.placeholder.com/40";

        const tbody = document.getElementById("userList");
        tbody.innerHTML = "";

        // Logged-in user
        const trUser = document.createElement("tr");
        trUser.innerHTML = `
            <td>${loggedUser.username}</td>
            <td>${loggedUser.email}</td>
            <td>${loggedUser.phone || "-"}</td>
            <td>${loggedUser.company || "-"}</td>
            <td>${loggedUser.gstNumber || "-"}</td>
            <td>${loggedUser.address || "-"}</td>
            <td>-</td>
        `;
        tbody.appendChild(trUser);

        try{
            const res = await fetch(API + "/users");
            const users = await res.json();
            users.forEach(u=>{
                if(u.email !== loggedUser.email){
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || "-"}</td>
                        <td>${u.company || "-"}</td>
                        <td>${u.gstNumber || "-"}</td>
                        <td>${u.address || "-"}</td>
                        <td>-</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }catch(e){ console.error("Dashboard error:", e); }

        loadProfileFields();
    }

    // Profile
    function loadProfileFields(){
        document.getElementById("proUsername").value = loggedUser.username;
        document.getElementById("proEmail").value = loggedUser.email;
        document.getElementById("proPassword").value = loggedUser.password;
        document.getElementById("proPhone").value = loggedUser.phone || "";
        document.getElementById("proBusinessName").value = loggedUser.company || "";
        document.getElementById("proGstNumber").value = loggedUser.gstNumber || "";
        document.getElementById("proAddress").value = loggedUser.address || "";
        document.getElementById("profilePicPreview").src = loggedUser.profilePic || "https://via.placeholder.com/80";
    }

    // Save profile
    async function saveProfile(){
        const pic = document.getElementById("profilePic");
        if(pic.files[0]){
            const reader = new FileReader();
            reader.onload = e => {
                loggedUser.profilePic = e.target.result;
                localStorage.setItem("loggedUser", JSON.stringify(loggedUser));
            };
            reader.readAsDataURL(pic.files[0]);
        }

        loggedUser.username = document.getElementById("proUsername").value;
        loggedUser.phone = document.getElementById("proPhone").value;
        loggedUser.company = document.getElementById("proBusinessName").value;
        loggedUser.gstNumber = document.getElementById("proGstNumber").value;
        loggedUser.address = document.getElementById("proAddress").value;

        await fetch(`${API}/api/profile/update`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(loggedUser)
        });

        alert("Profile Updated");
        await fetchLoggedUser();
        loadDashboard();
    }

    // Chat
    const chatBox = document.getElementById("chatBox");
    const chatEmailInput = document.getElementById("chatEmail");
    const msgInput = document.getElementById("msgInput");

    async function loadChat(email){
        if(!email) return;
        chatEmailInput.value = email;
        const res = await fetch(`${API}/chat/${loggedUser.email}/${email}`);
        const messages = await res.json();
        chatBox.innerHTML = "";
        messages.sort((a,b)=>a.timestamp-b.timestamp);
        messages.forEach(m=>{
            const div = document.createElement("div");
            div.classList.add("msg");
            div.classList.add(m.sender===loggedUser.email?"me":"other");
            const time = new Date(m.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
            div.innerHTML = `${m.message}<div class='time'>${time}</div>`;
            chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById("sendBtn").addEventListener("click", async ()=>{
        const receiver = chatEmailInput.value.trim();
        const message = msgInput.value.trim();
        const vanishSeconds = parseInt(document.getElementById("vanishTime").value);
        if(!receiver || !message) return alert("Enter email & message");

        const msgObj = { sender: loggedUser.email, receiver, message, vanishSeconds };
        await fetch(API + "/chat/send", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(msgObj) });
        stomp.send("/app/send", {}, JSON.stringify(msgObj));
        msgInput.value="";
        loadChat(receiver);
    });

    msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter") document.getElementById("sendBtn").click(); });

    // Page switch & logout
    function showPage(page,e){
        e && e.preventDefault();
        document.querySelectorAll("main section").forEach(s=>s.style.display="none");
        document.getElementById(page).style.display="block";
        document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
        if(e) e.target.classList.add("active");
        if(window.innerWidth<992) toggleSidebar();
    }
    function logout(){ localStorage.removeItem("loggedUser"); window.location.href="/login"; }
    function toggleSidebar(){ document.querySelector(".sidebar").classList.toggle("active"); }

    // Init
    loadDashboard();
</script>
</body>
</html>
