<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VanishChat - Dashboard</title>
    <style>
        * { box-sizing:border-box; margin:0; padding:0; font-family:Arial, sans-serif;}
        body { background:#f0f2f5; color:#333; }

        .topbar {
            background:#1a1a1a; color:white;
            height:60px; display:flex; align-items:center;
            justify-content:space-between; padding:0 20px;
            position:fixed; top:0; left:0; width:100%; z-index:1001;
        }
        .topbar img { width:40px; height:40px; border-radius:50%; }
        .topbar .user-info { display:flex; gap:10px; align-items:center; }

        .sidebar {
            position:fixed; top:60px; left:0; width:230px;
            height:calc(100% - 60px); background:#262D7A;
            color:white; padding:20px; transition:transform .3s;
        }
        .sidebar h2 { margin-bottom:20px; }
        .sidebar a {
            display:block; color:white; padding:10px;
            margin-bottom:10px; border-radius:6px;
            text-decoration:none; transition:background .3s;
        }
        .sidebar a.active, .sidebar a:hover {
            background:#00ffaa; color:#262D7A;
        }
        .sidebar button {
            margin-top:40px; padding:10px; width:100%;
            background:#e74c3c; border:none; border-radius:6px; cursor:pointer;
        }

        main { margin-left:230px; margin-top:60px; padding:20px; transition:.3s; }

        table { width:100%; border-collapse:collapse; margin-bottom:20px; }
        th, td { padding:10px; border-bottom:1px solid #ccc; text-align:left; }
        th { background:#00ffaa; color:#262D7A; }
        tr:hover { background:#ecf0f1; cursor:pointer; }

        #chatBox {
            background:#e5ddd5; height:400px; overflow-y:auto;
            padding:15px; border-radius:10px; margin-bottom:10px;
        }

        .msg { max-width:65%; padding:10px 14px; border-radius:20px;
            margin:5px 0; font-size:14px; position:relative; }
        .me { background:#dcf8c6; margin-left:auto; border-bottom-right-radius:0; }
        .other { background:white; margin-right:auto; border-bottom-left-radius:0; }
        .time { font-size:10px; opacity:.6; margin-top:4px; text-align:right; }

        input, select, textarea, button {
            width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;
        }
        button { cursor:pointer; border:none; background:#00ffaa; color:#262D7A; }

        @media (max-width:992px){
            .sidebar{transform:translateX(-100%);}
            .sidebar.active{transform:translateX(0);}
            main{margin-left:0;}
            .menu-toggle{display:block;font-size:1.5rem;cursor:pointer;}
        }

        #profilePicPreview, #businessProofPreview {
            max-width:100px; max-height:100px; display:block; margin-bottom:10px; border-radius:6px; object-fit:cover;
        }

        /* ===== Top Notification Bar ===== */
        #notificationBar {
            position:fixed; top:60px; left:230px; right:0;
            z-index:1002; display:flex; flex-direction:column;
            gap:5px; padding:10px; pointer-events:none;
        }
        @media (max-width:992px){ #notificationBar { left:0; } }
        .notification {
            background:#00ffaa; color:#262D7A;
            padding:10px 15px; border-radius:6px;
            font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);
            pointer-events:auto;
        }
    </style>
</head>
<body>

<header class="topbar">
    <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
    <div class="user-info">
        <img src="https://via.placeholder.com/40" id="topPic">
        <span id="topName">User</span>
    </div>
</header>

<div id="notificationBar"></div>

<aside class="sidebar">
    <h2>VanishChat</h2>
    <a href="#" class="active" onclick="showPage('dashboard', event)">Dashboard</a>
    <a href="#" onclick="showPage('chat', event)">Chat</a>
    <a href="#" onclick="showPage('profile', event)">Profile</a>
    <button onclick="logout()">Logout</button>
</aside>

<main>
    <section id="dashboard">
        <h1>Welcome, <span id="welcomeUser"></span> üëã</h1>
        <table>
            <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Pending Chat</th>
            </tr>
            </thead>
            <tbody id="userList"></tbody>
        </table>
    </section>

    <section id="chat" style="display:none;">
        <h1>Chat</h1>
        <input type="email" id="chatEmail" placeholder="Enter email to chat">
        <div id="chatBox"></div>
        <input type="text" id="msgInput" placeholder="Type message...">
        <select id="vanishTime">
            <option value="10">10s</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
        </select>
        <button id="sendBtn">Send</button>
    </section>

    <section id="profile" style="display:none;">
        <h1>Edit Profile</h1>
        <form id="profileForm">
            <img id="profilePicPreview" src="https://via.placeholder.com/80">
            <input type="file" id="profilePic" accept="image/*" onchange="previewImage(this,'profilePicPreview')">

            <input type="text" id="proUsername" placeholder="Username">
            <input type="email" id="proEmail" placeholder="Email" readonly>

            <div style="position:relative;">
                <input type="password" id="proPassword" placeholder="Password">
                <span onclick="togglePassword()" style="position:absolute;right:10px;top:10px;cursor:pointer;">üëÅÔ∏è</span>
            </div>

            <input type="text" id="proPhone" placeholder="Phone">
            <textarea id="proAddress" placeholder="Address"></textarea>
            <input type="text" id="proBusinessName" placeholder="Business Name">
            <input type="text" id="proGstNumber" placeholder="GST Number">

            <label>Existing Business Proof</label>
            <input type="text" id="proProofFilePath" placeholder="Existing file" readonly>
            <img id="businessProofPreview" src="" style="display:none;">

            <label>Upload New Business Proof</label>
            <input type="file" id="newBusinessProof" onchange="previewImage(this,'businessProofPreview')">

            <button type="button" onclick="saveProfile()">Save</button>
        </form>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
    const API = "http://localhost:8080";
    let loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
    let token = localStorage.getItem("token");

    if(!loggedUser || !token){
        alert("Please login first!");
        window.location.href="/login";
    }

    document.getElementById("topName").textContent = loggedUser.username;
    document.getElementById("topPic").src = loggedUser.profilePic || "https://via.placeholder.com/40";
    document.getElementById("welcomeUser").textContent = loggedUser.username;

    function toggleSidebar(){ document.querySelector(".sidebar").classList.toggle("active"); }
    function logout(){ localStorage.removeItem("loggedUser"); localStorage.removeItem("token"); window.location.href="/login"; }
    function showPage(page,event){
        event && event.preventDefault();
        document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
        document.getElementById(page).style.display="block";
        document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
        event.target.classList.add("active");
    }

    // ===================== DASHBOARD =====================
    async function loadDashboard() {
        const tbody = document.getElementById("userList");
        tbody.innerHTML = "";

        try {
            tbody.innerHTML += `<tr style="background:#dff0d8;">
                <td>${loggedUser.username}</td>
                <td>${loggedUser.email}</td>
                <td>${loggedUser.phone || "-"}</td>
                <td>${loggedUser.address || "-"}</td>
                <td>-</td>
            </tr>`;

            const res = await fetch(`${API}/users`);
            const users = await res.json();
            users.forEach(u => {
                if(u.email !== loggedUser.email){
                    tbody.innerHTML += `<tr>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || "-"}</td>
                        <td>${u.address || "-"}</td>
                        <td id="pending-${u.email}">${u.pendingChats || 0}</td>
                    </tr>`;
                }
            });
        } catch(e){ console.error("Error loading users:", e); }

        loadProfileFields();
    }

    // ===================== PROFILE =====================
    function loadProfileFields(){
        document.getElementById("proUsername").value = loggedUser.username;
        document.getElementById("proEmail").value = loggedUser.email;
        document.getElementById("proPassword").value = "";
        document.getElementById("proPhone").value = loggedUser.phone || "";
        document.getElementById("proAddress").value = loggedUser.address || "";
        document.getElementById("profilePicPreview").src = loggedUser.profilePic || "https://via.placeholder.com/80";
        document.getElementById("proBusinessName").value = loggedUser.businessName || "";
        document.getElementById("proGstNumber").value = loggedUser.gstNumber || "";
        document.getElementById("proProofFilePath").value = loggedUser.proofFilePath || "";
        if(loggedUser.proofFilePath) {
            document.getElementById("businessProofPreview").src = loggedUser.proofFilePath;
            document.getElementById("businessProofPreview").style.display = "block";
        }
    }

    function togglePassword(){
        const pass = document.getElementById("proPassword");
        pass.type = pass.type === "password" ? "text" : "password";
    }

    function previewImage(input, previewId){
        const file = input.files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = function(e){
                const img = document.getElementById(previewId);
                img.src = e.target.result;
                img.style.display = "block";
            }
            reader.readAsDataURL(file);
        }
    }

    async function saveProfile() {
    const profilePicFile = document.getElementById("profilePic").files[0];
    const proofFile = document.getElementById("newBusinessProof").files[0];

    let formData = new FormData();
    formData.append("username", document.getElementById("proUsername").value);
    formData.append("email", document.getElementById("proEmail").value);
    formData.append("password", document.getElementById("proPassword").value);
    formData.append("phone", document.getElementById("proPhone").value);
    formData.append("address", document.getElementById("proAddress").value);
    formData.append("businessName", document.getElementById("proBusinessName").value);
    formData.append("gstNumber", document.getElementById("proGstNumber").value);

    // Only append files if user uploaded new ones
    if(profilePicFile) formData.append("profilePic", profilePicFile);
    if(proofFile) formData.append("businessProof", proofFile);

    try {
        const res = await fetch(`${API}/api/profile`, {
            method: "PUT", // ya POST agar pehli baar create kar rahe ho
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });

        const data = await res.json();

        if(data.success && data.user){
            alert("Profile saved successfully!");

            // Update loggedUser in localStorage
            loggedUser = data.user;
            localStorage.setItem("loggedUser", JSON.stringify(loggedUser));

            // Reload profile fields so preview updates
            loadProfileFields();
        } else {
            alert("Error: " + (data.message || "Could not save profile"));
        }

    } catch(e){
        console.error("Error saving profile:", e);
        alert("Something went wrong while saving profile!");
    }
}

    // ===================== WEBSOCKET =====================
    function encodeEmail(email) {
        return email.replace(/\./g, "_dot_").replace(/@/g, "_at_");
    }

    let socket = new SockJS(`${API}/ws`);
    let stompClient = Stomp.over(socket);

    stompClient.connect({ Authorization: `Bearer ${token}` }, () => {
        console.log("Connected to WebSocket");

        // Subscribe to personal chat
        stompClient.subscribe("/chat/" + encodeEmail(loggedUser.email), msg => {
            const data = JSON.parse(msg.body);
            addMessage(data, data.sender===loggedUser.email ? true : false);

            // Show notification
            showNotification("New message from " + data.sender);

            // Update pending chat count
            const pendingTd = document.getElementById("pending-" + data.sender);
            if(pendingTd){
                pendingTd.textContent = parseInt(pendingTd.textContent || "0") + 1;
            } else { loadDashboard(); }

            // Remove message after vanishTime
            setTimeout(() => removeMessage(data.id), data.vanishTime * 1000);
        });

        // Notification channel
        stompClient.subscribe("/notify/" + encodeEmail(loggedUser.email), msg => {
            showNotification(msg.body);
        });
    });

    // Send message
    document.getElementById("sendBtn").addEventListener("click", () => {
        const chatEmail = document.getElementById("chatEmail").value;
        const message = document.getElementById("msgInput").value;
        const vanishTime = parseInt(document.getElementById("vanishTime").value);

        if (!chatEmail || !message) { alert("Enter email and message"); return; }

        const msg = {
            id: Date.now(),
            sender: loggedUser.email,
            receiver: chatEmail,
            receiverSafe: encodeEmail(chatEmail),
            message,
            vanishTime
        };

        stompClient.send("/app/send", {}, JSON.stringify(msg));
        addMessage(msg, true);
        document.getElementById("msgInput").value = "";
        setTimeout(() => removeMessage(msg.id), vanishTime * 1000);
    });

    // Add message to chat box
    function addMessage(msg, isMine) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.classList.add("msg", isMine ? "me" : "other");
        div.id = "msg-" + msg.id;
        div.innerHTML = `<strong>${isMine ? "Me" : msg.sender}:</strong> ${msg.message}
            <div class="time">${new Date().toLocaleTimeString()}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function removeMessage(id) {
        const el = document.getElementById("msg-" + id);
        if (el) el.remove();
    }

    // Notifications
    function showNotification(txt) {
        const note = document.createElement("div");
        note.classList.add("notification");
        note.innerText = txt;
        document.getElementById("notificationBar").appendChild(note);
        setTimeout(() => note.remove(), 4000);
    }

    // Reset pending count when user opens chat with someone
    document.getElementById("chatEmail").addEventListener("input", () => {
        const email = document.getElementById("chatEmail").value;
        const td = document.getElementById("pending-" + email);
        if(td) td.textContent = "0";
    });

    loadDashboard();
</script>

</body>
</html>
