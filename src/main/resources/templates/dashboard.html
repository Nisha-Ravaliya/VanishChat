<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VanishChat - Dashboard</title>
    <style>
        * { box-sizing:border-box; margin:0; padding:0; font-family:Arial, sans-serif;}
        body { background:#f0f2f5; color:#333; }

        .topbar {
            background:#1a1a1a; color:white;
            height:60px; display:flex; align-items:center;
            justify-content:space-between; padding:0 20px;
            position:fixed; top:0; left:0; width:100%; z-index:1000;
        }
        .topbar img { width:40px; height:40px; border-radius:50%; }
        .topbar .user-info { display:flex; gap:10px; align-items:center; }

        .sidebar {
            position:fixed; top:60px; left:0; width:230px;
            height:calc(100% - 60px); background:#262D7A;
            color:white; padding:20px; transition:transform .3s;
        }
        .sidebar h2 { margin-bottom:20px; }
        .sidebar a {
            display:block; color:white; padding:10px;
            margin-bottom:10px; border-radius:6px;
            text-decoration:none; transition:background .3s;
        }
        .sidebar a.active, .sidebar a:hover {
            background:#00ffaa; color:#262D7A;
        }
        .sidebar button {
            margin-top:40px; padding:10px; width:100%;
            background:#e74c3c; border:none; border-radius:6px; cursor:pointer;
        }

        main { margin-left:230px; margin-top:60px; padding:20px; transition:.3s; }

        table { width:100%; border-collapse:collapse; margin-bottom:20px; }
        th, td { padding:10px; border-bottom:1px solid #ccc; text-align:left; }
        th { background:#00ffaa; color:#262D7A; }
        tr:hover { background:#ecf0f1; cursor:pointer; }

        #chatBox {
            background:#e5ddd5; height:400px; overflow-y:auto;
            padding:15px; border-radius:10px; margin-bottom:10px;
        }

        .msg { max-width:65%; padding:10px 14px; border-radius:20px;
            margin:5px 0; font-size:14px; position:relative; }
        .me { background:#dcf8c6; margin-left:auto; border-bottom-right-radius:0; }
        .other { background:white; margin-right:auto; border-bottom-left-radius:0; }
        .time { font-size:10px; opacity:.6; margin-top:4px; text-align:right; }

        input, select, textarea, button {
            width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;
        }
        button { cursor:pointer; border:none; background:#00ffaa; color:#262D7A; }

        @media (max-width:992px){
            .sidebar{transform:translateX(-100%);}
            .sidebar.active{transform:translateX(0);}
            main{margin-left:0;}
            .menu-toggle{display:block;font-size:1.5rem;cursor:pointer;}
        }
    </style>
</head>

<body>

<header class="topbar">
    <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
    <div class="user-info">
        <img src="https://via.placeholder.com/40" id="topPic">
        <span id="topName">User</span>
    </div>
</header>

<aside class="sidebar">
    <h2>VanishChat</h2>
    <a href="#" class="active" onclick="showPage('dashboard', event)">Dashboard</a>
    <a href="#" onclick="showPage('chat', event)">Chat</a>
    <a href="#" onclick="showPage('profile', event)">Profile</a>
    <button onclick="logout()">Logout</button>
</aside>

<main>
    <!-- DASHBOARD -->
    <section id="dashboard">
        <h1>Welcome, <span id="welcomeUser"></span> üëã</h1>
        <table>
            <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Pending Chat</th>
            </tr>
            </thead>
            <tbody id="userList"></tbody>
        </table>
    </section>

    <!-- CHAT -->
    <section id="chat" style="display:none;">
        <h1>Chat</h1>
        <input type="email" id="chatEmail" placeholder="Enter email to chat">
        <div id="chatBox"></div>
        <input type="text" id="msgInput" placeholder="Type message...">
        <select id="vanishTime">
            <option value="10">10s</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
        </select>
        <button id="sendBtn">Send</button>
    </section>

    <!-- PROFILE -->
    <section id="profile" style="display:none;">
        <h1>Edit Profile</h1>

        <form id="profileForm">
            <!-- Profile pic preview -->
            <img id="profilePicPreview" src="https://via.placeholder.com/80" style="display:block;margin-bottom:10px;">
            <input type="file" id="profilePic" accept="image/*">

            <input type="text" id="proUsername" placeholder="Username">
            <input type="email" id="proEmail" placeholder="Email" readonly>

            <!-- Password field with toggle -->
            <div style="position:relative;">
                <input type="password" id="proPassword" placeholder="Password">
                <span onclick="togglePassword()" style="position:absolute;right:10px;top:10px;cursor:pointer;">üëÅÔ∏è</span>
            </div>

            <input type="text" id="proPhone" placeholder="Phone">
            <textarea id="proAddress" placeholder="Address"></textarea>

            <input type="text" id="proBusinessName" placeholder="Business Name">
            <input type="text" id="proGstNumber" placeholder="GST Number">

            <label>Business Proof File</label>
            <input type="text" id="proProofFilePath" placeholder="Existing file" readonly>
            <input type="file" id="newBusinessProof">

            <button type="button" onclick="saveProfile()">Save</button>
        </form>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
    const API = "http://localhost:8080";
    let loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
    if(!loggedUser){ alert("Please login first!"); window.location.href="/login"; }

    // TOPBAR + WELCOME
    document.getElementById("topName").textContent = loggedUser.username;
    document.getElementById("topPic").src = loggedUser.profilePic || "https://via.placeholder.com/40";
    document.getElementById("welcomeUser").textContent = loggedUser.username;

    // Sidebar toggle
    function toggleSidebar(){ document.querySelector(".sidebar").classList.toggle("active"); }
    function logout(){ localStorage.removeItem("loggedUser"); localStorage.removeItem("token"); window.location.href="/login"; }
    function showPage(page,event){
        event && event.preventDefault();
        document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
        document.getElementById(page).style.display="block";
        document.querySelectorAll(".sidebar a").forEach(a=>a.classList.remove("active"));
        event.target.classList.add("active");
    }

    // Load dashboard
    async function loadDashboard() {
        const tbody = document.getElementById("userList");
        tbody.innerHTML = "";

        tbody.innerHTML += `<tr>
            <td>${loggedUser.username}</td>
            <td>${loggedUser.email}</td>
            <td>${loggedUser.phone || "-"}</td>
            <td>${loggedUser.address || "-"}</td>
            <td>-</td>
        </tr>`;

        try {
            const res = await fetch(`${API}/users`);
            const users = await res.json();
            users.forEach(u => {
                if(u.email !== loggedUser.email){
                    tbody.innerHTML += `<tr>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || "-"}</td>
                        <td>${u.address || "-"}</td>
                        <td>-</td>
                    </tr>`;
                }
            });
        } catch(e){ console.error("Error loading users:", e); }

        loadProfileFields();
    }

    // Load profile fields
    function loadProfileFields(){
        document.getElementById("proUsername").value = loggedUser.username;
        document.getElementById("proEmail").value = loggedUser.email;
        document.getElementById("proPassword").value = ""; // blank for security
        document.getElementById("proPhone").value = loggedUser.phone || "";
        document.getElementById("proAddress").value = loggedUser.address || "";
        document.getElementById("profilePicPreview").src = loggedUser.profilePic || "https://via.placeholder.com/80";
        document.getElementById("proBusinessName").value = loggedUser.businessName || "";
        document.getElementById("proGstNumber").value = loggedUser.gstNumber || "";
        document.getElementById("proProofFilePath").value = loggedUser.proofFilePath || "";
    }

    // Toggle password visibility
    function togglePassword(){
        const pass = document.getElementById("proPassword");
        pass.type = pass.type === "password" ? "text" : "password";
    }

    // Save profile
    async function saveProfile() {
        const profilePicFile = document.getElementById("profilePic").files[0];
        const proofFile = document.getElementById("newBusinessProof").files[0];

        let formData = new FormData();
        formData.append("username", document.getElementById("proUsername").value);
        formData.append("email", document.getElementById("proEmail").value);
        formData.append("password", document.getElementById("proPassword").value);
        formData.append("phone", document.getElementById("proPhone").value);
        formData.append("address", document.getElementById("proAddress").value);
        formData.append("businessName", document.getElementById("proBusinessName").value);
        formData.append("gstNumber", document.getElementById("proGstNumber").value);
        if(profilePicFile) formData.append("profilePic", profilePicFile);
        if(proofFile) formData.append("businessProof", proofFile);

        try {
            const token = localStorage.getItem("token");
            const res = await fetch(`${API}/api/profile`, {
                method: "PUT",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
            });
            const data = await res.json();
            if(data.success){
                alert("Profile updated!");
                localStorage.setItem("loggedUser", JSON.stringify(data.user));
                loggedUser = data.user;
                loadDashboard();
            } else {
                alert("Update failed: "+data.message);
            }
        } catch(e){
            console.error(e);
            alert("Error updating profile");
        }
    }

    // ====================== CHAT ======================
    let socket = new SockJS(`${API}/ws`);
    let stompClient = Stomp.over(socket);
    stompClient.connect({}, ()=>{
        console.log("Connected to WebSocket");

        stompClient.subscribe("/chat/"+loggedUser.email, msg=>{
            const data = JSON.parse(msg.body);
            addMessage(data, false);
        });

        stompClient.subscribe("/notify/"+loggedUser.email, msg=>{
            showNotification(msg.body);
        });
    });

    document.getElementById("sendBtn").addEventListener("click", ()=>{
        const receiver = document.getElementById("chatEmail").value;
        const message = document.getElementById("msgInput").value;
        if(!receiver || !message) return;

        const msg = { sender: loggedUser.email, receiver, message };
        stompClient.send("/app/send", {}, JSON.stringify(msg));
        addMessage(msg, true);
        document.getElementById("msgInput").value = "";
    });

    function addMessage(msg, isMine){
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.classList.add("msg", isMine?"me":"other");
        div.innerHTML = `${msg.message}<div class="time">${new Date().toLocaleTimeString()}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function showNotification(txt){
        const note = document.createElement("div");
        note.style.background="#00ffaa"; note.style.padding="10px";
        note.style.margin="10px 0"; note.style.borderRadius="6px"; note.innerText=txt;
        document.body.appendChild(note);
        setTimeout(()=>{ note.remove(); },4000);
    }

    // Initial load
    loadDashboard();
</script>
</body>
</html>
